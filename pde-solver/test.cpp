#define CATCH_CONFIG_MAIN
#define CATCH_CONFIG_ENABLE_BENCHMARKING
#include <catch2/catch.hpp>
#include <cstdint>
#include "ioutils.h"
#include "matrixutils.h"
#include "solver.h"
#include <iostream>
#include <memory>
#include <thread>



std::vector<std::vector<double>> test_matrix = {{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
                                                 ,{1,0.49707,0.29653,0.20077,0.14718,0.11327,0.089806,0.072525,0.059229,0.048683,0.040141,0.033124,0.027308,0.022461,0.018414,0.015033,0.012214,0.0098707,0.007931,0.0063329,0.0050241,0.0039587,0.0030975,0.002406,0.0018552,0.0014196,0.0010779,0.000812,0.00060686,0.00044983,0.0003307,0.00024104,0.00017415,0.00012461,8.8191e-05,6.152e-05,4.1999e-05,2.7564e-05,1.6601e-05,7.7866e-06,0}
                                                 ,{1,0.69181,0.4884,0.35951,0.27489,0.21632,0.1737,0.14137,0.11603,0.095696,0.079096,0.065387,0.053978,0.044445,0.036466,0.029791,0.024218,0.019581,0.015738,0.012571,0.0099758,0.0078625,0.0061529,0.0047805,0.0036864,0.0028213,0.0021424,0.0016142,0.0012064,0.00089436,0.0006575,0.00047931,0.00034629,0.00024782,0.00017538,0.00012236,8.3524e-05,5.4826e-05,3.3017e-05,1.5488e-05,0}
                                                 ,{1,0.78188,0.60595,0.47429,0.37693,0.30391,0.24786,0.20381,0.16846,0.13964,0.11584,0.096023,0.079437,0.065515,0.053824,0.044018,0.035815,0.028978,0.023306,0.018625,0.014787,0.011658,0.0091266,0.0070925,0.0054709,0.0041877,0.0031808,0.0023968,0.0017917,0.0013283,0.00097675,0.00071205,0.00051453,0.00036821,0.00026062,0.00018182,0.00012414,8.148e-05,4.9077e-05,2.3019e-05,0}
                                                 ,{1,0.82993,0.67954,0.55522,0.45524,0.37524,0.31083,0.25843,0.21533,0.17954,0.14961,0.12444,0.10322,0.085308,0.070204,0.057494,0.046833,0.037929,0.030529,0.024415,0.019394,0.015299,0.011981,0.0093149,0.0071871,0.0055033,0.0041808,0.0031513,0.002356,0.0017472,0.0012848,0.00093686,0.000677,0.00048458,0.00034299,0.00023933,0.0001634,0.00010727,6.4603e-05,3.0307e-05,0}
                                                 ,{1,0.8585,0.72746,0.61241,0.51436,0.43192,0.36286,0.30492,0.25614,0.2149,0.17993,0.15023,0.12499,0.10355,0.085388,0.070042,0.057133,0.046322,0.037321,0.029871,0.023745,0.018742,0.014686,0.011423,0.0088174,0.0067536,0.0051327,0.0038695,0.0028939,0.0021464,0.0015788,0.0011513,0.0008322,0.0005957,0.00042173,0.00029428,0.00020095,0.00013191,7.9462e-05,3.7274e-05,0}
                                                 ,{1,0.87686,0.75993,0.65334,0.55882,0.47637,0.4051,0.34372,0.29094,0.24559,0.20663,0.1732,0.14455,0.12008,0.099225,0.08154,0.06661,0.054076,0.043615,0.034941,0.027797,0.021956,0.017215,0.013397,0.010346,0.0079278,0.0060268,0.0045454,0.0034001,0.0025227,0.0018559,0.0013538,0.00097861,0.00070068,0.00049608,0.00034624,0.00023643,0.00015524,9.3506e-05,4.3869e-05,0}
                                                 ,{1,0.88931,0.78265,0.68308,0.59234,0.51103,0.43898,0.37561,0.32015,0.27178,0.22974,0.19331,0.16185,0.1348,0.11164,0.091913,0.075204,0.061134,0.049365,0.039586,0.031521,0.024915,0.019548,0.015221,0.011761,0.0090159,0.0068572,0.0051732,0.0038712,0.0028728,0.0021142,0.0015424,0.0011153,0.00079861,0.00056556,0.00039475,0.00026962,0.00017702,0.00010665,5.0032e-05,0}
                                                 ,{1,0.89807,0.79897,0.705,0.61773,0.53797,0.46597,0.40156,0.34435,0.29383,0.24944,0.21065,0.17691,0.14773,0.12261,0.10114,0.082882,0.06747,0.054546,0.043787,0.034895,0.027605,0.021673,0.016887,0.013054,0.010013,0.0076182,0.0057498,0.0043039,0.0031951,0.0023518,0.0017163,0.0012412,0.00088904,0.00062965,0.00043959,0.00030025,0.00019718,0.00011879,5.5736e-05,0}
                                                 ,{1,0.90441,0.81092,0.72135,0.63706,0.55891,0.48736,0.42249,0.36419,0.31215,0.26603,0.22541,0.18985,0.15891,0.13218,0.10922,0.089652,0.073079,0.059152,0.047533,0.037916,0.030018,0.023585,0.018387,0.014223,0.010914,0.0083077,0.0062723,0.0046969,0.0034877,0.0025681,0.0018745,0.001356,0.0009714,0.00068816,0.00048047,0.00032826,0.00021557,0.0001299,6.0943e-05,0}
                                                 ,{1,0.90907,0.8198,0.73365,0.65183,0.57518,0.50424,0.43927,0.38031,0.32724,0.27984,0.23781,0.20081,0.16848,0.14041,0.11622,0.095538,0.077981,0.063191,0.050831,0.040582,0.032155,0.025281,0.019722,0.015263,0.011718,0.0089238,0.0067405,0.005049,0.0037506,0.0027623,0.0020169,0.0014593,0.0010456,0.00074083,0.00051738,0.00035348,0.00023219,0.0001399,6.565e-05,0}
                                                 ,{1,0.91255,0.82645,0.74297,0.66315,0.58781,0.51752,0.45263,0.3933,0.33953,0.2912,0.24812,0.21,0.17654,0.14739,0.1222,0.10059,0.082205,0.066687,0.053694,0.042906,0.034021,0.026767,0.020893,0.016179,0.012427,0.0094678,0.0071537,0.0053607,0.0039832,0.0029346,0.0021431,0.0015511,0.0011116,0.00078774,0.00055018,0.00037598,0.00024697,0.00014884,6.9838e-05,0}
                                                 ,{1,0.91516,0.83148,0.75005,0.67183,0.59759,0.52792,0.46321,0.40369,0.34945,0.30046,0.25658,0.2176,0.18326,0.15324,0.12723,0.10487,0.085798,0.06967,0.056147,0.0449,0.035629,0.028049,0.021907,0.016972,0.013043,0.0099406,0.0075142,0.0056324,0.0041865,0.0030851,0.0022537,0.0016313,0.0011694,0.00082882,0.00057901,0.0003957,0.00025998,0.00015667,7.3526e-05,0}
                                                 ,{1,0.91712,0.83527,0.75543,0.67848,0.60514,0.53602,0.47151,0.41193,0.35738,0.30792,0.26344,0.22381,0.18878,0.15808,0.13141,0.10844,0.088805,0.072179,0.058214,0.046589,0.036992,0.02914,0.02277,0.01765,0.013569,0.010346,0.0078229,0.0058659,0.0043611,0.0032147,0.0023488,0.0017006,0.0012192,0.00086434,0.00060386,0.00041277,0.0002712,0.00016347,7.671e-05,0}
                                                 ,{1,0.9186,0.83814,0.75952,0.68355,0.61094,0.54227,0.47798,0.41838,0.36365,0.31384,0.26893,0.2288,0.19324,0.16201,0.13483,0.11136,0.091282,0.07425,0.059929,0.047991,0.038128,0.03005,0.023493,0.018217,0.014011,0.010686,0.0080831,0.0060625,0.0045087,0.0033241,0.0024294,0.0017592,0.0012615,0.00089438,0.00062498,0.00042722,0.00028074,0.00016922,7.9419e-05,0}
                                                 ,{1,0.9197,0.84028,0.76258,0.68737,0.61534,0.54704,0.48294,0.42337,0.36851,0.31847,0.27325,0.23274,0.19678,0.16515,0.13756,0.11371,0.093278,0.075926,0.061318,0.049131,0.039053,0.030793,0.024083,0.018682,0.014373,0.010966,0.0082969,0.0062247,0.0046301,0.0034145,0.0024957,0.0018077,0.0012964,0.0009193,0.00064242,0.00043923,0.00028863,0.000174,8.1658e-05,0}
                                                 ,{1,0.92051,0.84186,0.76484,0.69021,0.61861,0.55061,0.48667,0.42713,0.3722,0.322,0.27655,0.23577,0.19952,0.16758,0.13969,0.11554,0.094841,0.077239,0.062412,0.050029,0.039784,0.031381,0.024552,0.019051,0.014661,0.011189,0.0084676,0.0063538,0.0047272,0.0034866,0.002549,0.0018464,0.0013244,0.00093921,0.00065645,0.00044882,0.00029498,0.00017782,8.3463e-05,0}
                                                 ,{1,0.92109,0.84299,0.76646,0.69224,0.62096,0.55319,0.48937,0.42987,0.37489,0.32459,0.27898,0.23801,0.20155,0.16938,0.14127,0.11692,0.09601,0.078227,0.063233,0.050707,0.040335,0.031826,0.024906,0.019332,0.01488,0.011358,0.0085971,0.0064523,0.004801,0.0035417,0.0025894,0.001876,0.0013457,0.00095447,0.00066713,0.00045619,0.00029982,0.00018076,8.4836e-05,0}
                                                 ,{1,0.92148,0.84374,0.76755,0.6936,0.62254,0.55492,0.4912,0.43172,0.37673,0.32635,0.28064,0.23955,0.20294,0.17063,0.14236,0.11786,0.096822,0.078911,0.063805,0.051178,0.04072,0.032136,0.025154,0.019527,0.015033,0.011477,0.0086882,0.0065212,0.0048531,0.0035802,0.002618,0.0018968,0.0013608,0.00096516,0.00067469,0.00046135,0.00030324,0.00018281,8.581e-05,0}
                                                 ,{1,0.9217,0.84417,0.76817,0.69438,0.62345,0.55593,0.49225,0.43279,0.37779,0.32738,0.28161,0.24044,0.20375,0.17135,0.143,0.11842,0.097297,0.079315,0.064141,0.051457,0.040947,0.03232,0.025301,0.019643,0.015124,0.011547,0.0087419,0.0065623,0.0048837,0.0036032,0.0026349,0.0019092,0.0013697,0.00097156,0.00067914,0.00046444,0.00030526,0.00018405,8.6384e-05,0}
                                                 ,{1,0.92177,0.84431,0.76837,0.69464,0.62375,0.55625,0.4926,0.43314,0.37814,0.32771,0.28193,0.24074,0.20402,0.17159,0.14321,0.1186,0.097455,0.079447,0.064253,0.051548,0.041022,0.03238,0.025349,0.019681,0.015154,0.01157,0.0087599,0.0065757,0.004894,0.0036107,0.0026405,0.0019132,0.0013727,0.00097364,0.00068065,0.00046544,0.00030594,0.00018445,8.6578e-05,0}
                                                 ,{1,0.9217,0.84417,0.76817,0.69438,0.62345,0.55593,0.49225,0.43279,0.37779,0.32738,0.28161,0.24044,0.20375,0.17135,0.143,0.11842,0.097297,0.079315,0.064141,0.051457,0.040947,0.03232,0.025301,0.019643,0.015124,0.011547,0.0087419,0.0065623,0.0048837,0.0036032,0.0026349,0.0019092,0.0013697,0.00097156,0.00067914,0.00046444,0.00030526,0.00018405,8.6384e-05,0}
                                                 ,{1,0.92148,0.84374,0.76755,0.6936,0.62254,0.55492,0.4912,0.43172,0.37673,0.32635,0.28064,0.23955,0.20294,0.17063,0.14236,0.11786,0.096822,0.078911,0.063805,0.051178,0.04072,0.032136,0.025154,0.019527,0.015033,0.011477,0.0086882,0.0065212,0.0048531,0.0035802,0.002618,0.0018968,0.0013608,0.00096516,0.00067469,0.00046135,0.00030324,0.00018281,8.581e-05,0}
                                                 ,{1,0.92109,0.84299,0.76646,0.69224,0.62096,0.55319,0.48937,0.42987,0.37489,0.32459,0.27898,0.23801,0.20155,0.16938,0.14127,0.11692,0.09601,0.078227,0.063233,0.050707,0.040335,0.031826,0.024906,0.019332,0.01488,0.011358,0.0085971,0.0064523,0.004801,0.0035417,0.0025894,0.001876,0.0013457,0.00095447,0.00066713,0.00045619,0.00029982,0.00018076,8.4836e-05,0}
                                                 ,{1,0.92051,0.84186,0.76484,0.69021,0.61861,0.55061,0.48667,0.42713,0.3722,0.322,0.27655,0.23577,0.19952,0.16758,0.13969,0.11554,0.094841,0.077239,0.062412,0.050029,0.039784,0.031381,0.024552,0.019051,0.014661,0.011189,0.0084676,0.0063538,0.0047272,0.0034866,0.002549,0.0018464,0.0013244,0.00093921,0.00065645,0.00044882,0.00029498,0.00017782,8.3463e-05,0}
                                                 ,{1,0.9197,0.84028,0.76258,0.68737,0.61534,0.54704,0.48294,0.42337,0.36851,0.31847,0.27325,0.23274,0.19678,0.16515,0.13756,0.11371,0.093278,0.075926,0.061318,0.049131,0.039053,0.030793,0.024083,0.018682,0.014373,0.010966,0.0082969,0.0062247,0.0046301,0.0034145,0.0024957,0.0018077,0.0012964,0.0009193,0.00064242,0.00043923,0.00028863,0.000174,8.1658e-05,0}
                                                 ,{1,0.9186,0.83814,0.75952,0.68355,0.61094,0.54227,0.47798,0.41838,0.36365,0.31384,0.26893,0.2288,0.19324,0.16201,0.13483,0.11136,0.091282,0.07425,0.059929,0.047991,0.038128,0.03005,0.023493,0.018217,0.014011,0.010686,0.0080831,0.0060625,0.0045087,0.0033241,0.0024294,0.0017592,0.0012615,0.00089438,0.00062498,0.00042722,0.00028074,0.00016922,7.9419e-05,0}
                                                 ,{1,0.91712,0.83527,0.75543,0.67848,0.60514,0.53602,0.47151,0.41193,0.35738,0.30792,0.26344,0.22381,0.18878,0.15808,0.13141,0.10844,0.088805,0.072179,0.058214,0.046589,0.036992,0.02914,0.02277,0.01765,0.013569,0.010346,0.0078229,0.0058659,0.0043611,0.0032147,0.0023488,0.0017006,0.0012192,0.00086434,0.00060386,0.00041277,0.0002712,0.00016347,7.671e-05,0}
                                                 ,{1,0.91516,0.83148,0.75005,0.67183,0.59759,0.52792,0.46321,0.40369,0.34945,0.30046,0.25658,0.2176,0.18326,0.15324,0.12723,0.10487,0.085798,0.06967,0.056147,0.0449,0.035629,0.028049,0.021907,0.016972,0.013043,0.0099406,0.0075142,0.0056324,0.0041865,0.0030851,0.0022537,0.0016313,0.0011694,0.00082882,0.00057901,0.0003957,0.00025998,0.00015667,7.3526e-05,0}
                                                 ,{1,0.91255,0.82645,0.74297,0.66315,0.58781,0.51752,0.45263,0.3933,0.33953,0.2912,0.24812,0.21,0.17654,0.14739,0.1222,0.10059,0.082205,0.066687,0.053694,0.042906,0.034021,0.026767,0.020893,0.016179,0.012427,0.0094678,0.0071537,0.0053607,0.0039832,0.0029346,0.0021431,0.0015511,0.0011116,0.00078774,0.00055018,0.00037598,0.00024697,0.00014884,6.9838e-05,0}
                                                 ,{1,0.90907,0.8198,0.73365,0.65183,0.57518,0.50424,0.43927,0.38031,0.32724,0.27984,0.23781,0.20081,0.16848,0.14041,0.11622,0.095538,0.077981,0.063191,0.050831,0.040582,0.032155,0.025281,0.019722,0.015263,0.011718,0.0089238,0.0067405,0.005049,0.0037506,0.0027623,0.0020169,0.0014593,0.0010456,0.00074083,0.00051738,0.00035348,0.00023219,0.0001399,6.565e-05,0}
                                                 ,{1,0.90441,0.81092,0.72135,0.63706,0.55891,0.48736,0.42249,0.36419,0.31215,0.26603,0.22541,0.18985,0.15891,0.13218,0.10922,0.089652,0.073079,0.059152,0.047533,0.037916,0.030018,0.023585,0.018387,0.014223,0.010914,0.0083077,0.0062723,0.0046969,0.0034877,0.0025681,0.0018745,0.001356,0.0009714,0.00068816,0.00048047,0.00032826,0.00021557,0.0001299,6.0943e-05,0}
                                                 ,{1,0.89807,0.79897,0.705,0.61773,0.53797,0.46597,0.40156,0.34435,0.29383,0.24944,0.21065,0.17691,0.14773,0.12261,0.10114,0.082882,0.06747,0.054546,0.043787,0.034895,0.027605,0.021673,0.016887,0.013054,0.010013,0.0076182,0.0057498,0.0043039,0.0031951,0.0023518,0.0017163,0.0012412,0.00088904,0.00062965,0.00043959,0.00030025,0.00019718,0.00011879,5.5736e-05,0}
                                                 ,{1,0.88931,0.78265,0.68308,0.59234,0.51103,0.43898,0.37561,0.32015,0.27178,0.22974,0.19331,0.16185,0.1348,0.11164,0.091913,0.075204,0.061134,0.049365,0.039586,0.031521,0.024915,0.019548,0.015221,0.011761,0.0090159,0.0068572,0.0051732,0.0038712,0.0028728,0.0021142,0.0015424,0.0011153,0.00079861,0.00056556,0.00039475,0.00026962,0.00017702,0.00010665,5.0032e-05,0}
                                                 ,{1,0.87686,0.75993,0.65334,0.55882,0.47637,0.4051,0.34372,0.29094,0.24559,0.20663,0.1732,0.14455,0.12008,0.099225,0.08154,0.06661,0.054076,0.043615,0.034941,0.027797,0.021956,0.017215,0.013397,0.010346,0.0079278,0.0060268,0.0045454,0.0034001,0.0025227,0.0018559,0.0013538,0.00097861,0.00070068,0.00049608,0.00034624,0.00023643,0.00015524,9.3506e-05,4.3869e-05,0}
                                                 ,{1,0.8585,0.72746,0.61241,0.51436,0.43192,0.36286,0.30492,0.25614,0.2149,0.17993,0.15023,0.12499,0.10355,0.085388,0.070042,0.057133,0.046322,0.037321,0.029871,0.023745,0.018742,0.014686,0.011423,0.0088174,0.0067536,0.0051327,0.0038695,0.0028939,0.0021464,0.0015788,0.0011513,0.0008322,0.0005957,0.00042173,0.00029428,0.00020095,0.00013191,7.9462e-05,3.7274e-05,0}
                                                 ,{1,0.82993,0.67954,0.55522,0.45524,0.37524,0.31083,0.25843,0.21533,0.17954,0.14961,0.12444,0.10322,0.085308,0.070204,0.057494,0.046833,0.037929,0.030529,0.024415,0.019394,0.015299,0.011981,0.0093149,0.0071871,0.0055033,0.0041808,0.0031513,0.002356,0.0017472,0.0012848,0.00093686,0.000677,0.00048458,0.00034299,0.00023933,0.0001634,0.00010727,6.4603e-05,3.0307e-05,0}
                                                 ,{1,0.78188,0.60595,0.47429,0.37693,0.30391,0.24786,0.20381,0.16846,0.13964,0.11584,0.096023,0.079437,0.065515,0.053824,0.044018,0.035815,0.028978,0.023306,0.018625,0.014787,0.011658,0.0091266,0.0070925,0.0054709,0.0041877,0.0031808,0.0023968,0.0017917,0.0013283,0.00097675,0.00071205,0.00051453,0.00036821,0.00026062,0.00018182,0.00012414,8.148e-05,4.9077e-05,2.3019e-05,0}
                                                 ,{1,0.69181,0.4884,0.35951,0.27489,0.21632,0.1737,0.14137,0.11603,0.095696,0.079096,0.065387,0.053978,0.044445,0.036466,0.029791,0.024218,0.019581,0.015738,0.012571,0.0099758,0.0078625,0.0061529,0.0047805,0.0036864,0.0028213,0.0021424,0.0016142,0.0012064,0.00089436,0.0006575,0.00047931,0.00034629,0.00024782,0.00017538,0.00012236,8.3524e-05,5.4826e-05,3.3017e-05,1.5488e-05,0}
                                                 ,{1,0.49707,0.29653,0.20077,0.14718,0.11327,0.089806,0.072525,0.059229,0.048683,0.040141,0.033124,0.027308,0.022461,0.018414,0.015033,0.012214,0.0098707,0.007931,0.0063329,0.0050241,0.0039587,0.0030975,0.002406,0.0018552,0.0014196,0.0010779,0.000812,0.00060686,0.00044983,0.0003307,0.00024104,0.00017415,0.00012461,8.8191e-05,6.152e-05,4.1999e-05,2.7564e-05,1.6601e-05,7.7866e-06,0}
                                                 ,{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}};

int n = test_matrix.size();
std::vector<double> zero_vect{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
std::vector<double> one_vect{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
std::vector<std::vector<double>> f(n, one_vect);
std::vector<std::vector<double>> h(n, zero_vect);
int steps = 1000;
double tol = 0.25;

matrix f_m(f);
matrix h_m(h);

TEST_CASE("Test and benchmark pde-solver") {
  std::unique_ptr<solver_manager> pde_solver;
  SECTION("Diffusion solver") {
    pde_solver = std::make_unique<diffusion>(f_m, h_m, steps, false, false);
    matrix a = pde_solver->solve();
    REQUIRE(a.size() == test_matrix.size());

    for (int i = 2; i < a.size() - 2; ++i) {
      for (int j = 2; j < a[i].size() - 2; ++j) {
        REQUIRE(std::abs(a[i][j] - test_matrix[i][j]) < tol);
      }
    }
    BENCHMARK("Diffusion benchmark") {
        return pde_solver->solve();
    };
  }
  SECTION("Jacobi solver") {
    pde_solver = std::make_unique<jacobi>(f_m, h_m, steps, false, false);
    matrix a = pde_solver->solve();
    REQUIRE(a.size() == test_matrix.size());

    for (int i = 2; i < a.size() - 2; ++i) {
      for (int j = 2; j < a[i].size() - 2; ++j) {
        REQUIRE(std::abs(a[i][j] - test_matrix[i][j]) < tol);
      }
    }
    BENCHMARK("Jacobi benchmark") {
        return pde_solver->solve();
    };
  }
  SECTION("Gauss-Seidel solver") {
    pde_solver = std::make_unique<gauss>(f_m, h_m, steps, false, false);
    matrix a = pde_solver->solve();
    REQUIRE(a.size() == test_matrix.size());

    for (int i = 2; i < a.size() - 2; ++i) {
      for (int j = 2; j < a[i].size() - 2; ++j) {
        REQUIRE(std::abs(a[i][j] - test_matrix[i][j]) < tol);
      }
    }
    BENCHMARK("Gauss-Seidel benchmark") {
        return pde_solver->solve();
    };
  }
}
